<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechThrift Partners - Products</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <script src="https://kit.fontawesome.com/05e3d8d374.js" crossorigin="anonymous"></script>
    <script src="../scripts/sidebar.js"></script>
    <link rel="stylesheet" href="../styles/stylesheet.css">
    <link rel="stylesheet" href="../styles/adminstyles.css">

    <!-- Bootstrap Bundle JS (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- PayPal API -->
    <script
        src="https://www.paypal.com/sdk/js?client-id=AU12GNf0wBJuuthVz7Xw9J7oiobcBjeAVYpoxEuhpGQKtOlKVYsn3nIbTSXOgNfRTdZrONxCW1Cm6gtB&currency=EUR&locale=en_PT&components=buttons,applepay"></script>
    <!-- PayPal API -->

</head>

<body>
    <style>
        #dropzone:hover {
            background-color: #f8f9fa;
        }
    </style>
    <!-- Header -->
    <header class="p-3 border-bottom bg-white">
        <div class="d-flex justify-content-between container">
            <div class="row align-items-center gap-3">
                <!-- Left elements -->
                <div class="col-lg-5 col-md-12 col-12 d-flex w-auto align-items-center">
                    <a id="header-brand" onclick="localStorage.setItem('activeNavLink', 'adminDashboard')"
                        href="/adminDashboard" class="ms-1">
                        <img alt="TechThrift's logo" src="../media/images/logo_hor_partners.png">
                    </a>
                </div>
                <!-- Left elements -->
            </div>
            <div class="d-flex flex-wrap justify-content-center 
                    align-items-center gap-1 ms-auto">
                <a href="/authentication" id="username" class="border 
                rounded py-1 px-3 nav-link d-flex h-auto
                align-self-center
                align-items-center btn btn-light">
                    <i class="fas fa-user-alt m-1 me-md-2"></i>
                    <p class="d-none d-md-block mb-0">Â·Â·Â·</p>
                </a>
                <button id="toggle-mode"
                    class="btn border rounded py-1 px-3 nav-link d-flex align-items-center btn btn-light">
                    &nbsp;<i id="mode-icon" class="fas fa-moon"></i>&nbsp;
                </button>
            </div>
        </div>
    </header>
    <!-- Header -->


    <div class="d-flex">
        <div class="sidebar p-3 bg-light vh-100" style="width: 250px;">
            <h4 class="text-center">Admin Panel</h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminDashboard"><i
                            class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminProducts"><i class="fas fa-box me-2"></i>Products</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminOrders"><i class="fas fa-shopping-cart me-2"></i>Orders</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminCharities"><i class="fas fa-users me-2"></i>Charities</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminDonations"><i
                            class="fas fa-hand-holding-heart me-2"></i>Donations</a>
                </li>
            </ul>
        </div>


        <div class="content p-4" style="flex-grow: 1;">
            <div class="d-flex justify-content-between align-items-center mb-4" id="top-buttons">
                <h2>Product List</h2>
                <div>
                    <button id="set-for-sale-btn" class="btn btn-light" disabled>Set For Sale</button>

                    <button class="btn btn-light" id="register-sale">Add Selected</button>

                    <button class="btn btn-light" id="delete-selected">Delete Selected</button>
                    <button class="btn btn-success" onclick="showAddProductForm()">Add Product</button>
                </div>
            </div>

            <div class="row mb-4 justify-content-between" id="filters-row">
                <div class="col-md-4 mb-2">
                    <input type="text" id="search-bar" class="form-control" placeholder="Search products...">
                </div>
                <div class="col-md-7 d-flex justify-content-end align-items-center gap-3">
                    <select id="condition-filter" class="form-select w-auto">
                        <option value="">All Conditions</option>
                    </select>
                    <select id="availability-filter" class="form-select w-auto">
                        <option value="">All Availability</option>
                        <option value="true">Available</option>
                        <option value="false">Unavailable</option>
                    </select>
                    <button class="btn btn-light" id="filter-btn">Filter</button>
                </div>
            </div>

            <!-- Table to select products -->
            <div class="table-responsive" id="product-table">
                <div class="rounded-3 border overflow-auto">
                    <table class="table table-borderless table-striped table-hover rounded-3">
                        <thead class="table-light">
                            <tr>
                                <th><input type="checkbox" id="select-all" onclick="toggleAllProducts(this)"></th>
                                <th>Product ID</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Category</th>
                                <th>Condition</th>
                                <th>Availability</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="product-list" class="animate-list"></tbody>
                    </table>
                </div>
                <nav class="mt-3">
                    <ul class="pagination justify-content-center" id="pagination-controls"></ul>
                </nav>
            </div>



            <!-- Modal to display selected products -->
            <div id="sale-modal" class="modal fade" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Register Sale</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <input type="text" id="sale-product-id" class="form-control"
                                    placeholder="Enter Product ID">
                                <button type="button" class="btn btn-outline-primary mt-2">Add</button>
                            </div>
                            <ul id="sale-product-list" class="list-group my-3">
                                <p class="text-muted">Products will appear here.</p>
                            </ul>
                            <div><strong>Total:</strong> <span id="sale-total-price">â‚¬0.00</span></div>
                            <div id="paypal" class="d-none my-4"></div>
                        </div>
                        <div class="modal-footer">
                            <!-- Reset button dynamically added via JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Set for Sale Modal -->
            <div class="modal fade" id="set-sale-modal" tabindex="-1" aria-labelledby="setSaleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="set-sale-form">
                            <div class="modal-header">
                                <h5 class="modal-title" id="setSaleModalLabel">Set Product for Sale</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="set-sale-product-id">
                                <div class="mb-3">
                                    <label for="set-sale-price" class="form-label">Sale Price</label>
                                    <input type="number" class="form-control" id="set-sale-price" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-success">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>




            <div id="add-product-form" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Add New Product</h2>
                    <div>
                        <button class="btn btn-light me-2" onclick="hideAddProductForm()">Cancel</button>
                        <button type="submit" class="btn btn-success" form="productForm">Submit Product</button>
                    </div>
                </div>

                <form id="productForm" enctype="multipart/form-data">
                    <div class="row">
                        <!-- COLUNA ESQUERDA -->
                        <div class="col-md-6">
                            <div class="mb-3" id="form-group-name">
                                <label for="product-name" class="form-label">Product Name</label>
                                <input type="text" id="product-name" name="name" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="product-condition" class="form-label">Condition</label>
                                <select id="product-condition" name="product_condition" class="form-select" required>
                                    <option>Like New</option>
                                    <option>Excellent</option>
                                    <option>Good</option>
                                    <option>Needs Repair</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="product-category" class="form-label">Category</label>
                                <select id="product-category" name="category" class="form-select" required>
                                    <option>Smartphones</option>
                                    <option>Laptops & PCs</option>
                                    <option>Smartwatches</option>
                                    <option>Gaming</option>
                                    <option>TVs & Monitors</option>
                                    <option>Audio</option>
                                    <option>Tablets</option>
                                    <option>Cameras</option>
                                    <option>Accessories</option>
                                    <option>Home Appliances</option>
                                    <option>Other</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="product-brand" class="form-label">Brand</label>
                                <input type="text" id="product-brand" name="brand" class="form-control"
                                    list="brand-suggestions" required>
                                <datalist id="brand-suggestions">
                                    <option value="Apple">
                                    <option value="Samsung">
                                    <option value="Dell">
                                    <option value="HP">
                                    <option value="Microsoft">
                                    <option value="Xiaomi">
                                    <option value="LG">
                                    <option value="Sony">
                                    <option value="Fitbit">
                                    <option value="Nintendo">
                                    <option value="Razer">
                                    <option value="Bose">
                                    <option value="GoPro">
                                    <option value="Canon">
                                    <option value="Other">
                                </datalist>
                            </div>


                            <div class="mb-3" id="form-group-model_code">
                                <label for="product-model-code" class="form-label">Model Code</label>
                                <input type="text" id="product-model-code" name="model_code" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-color">
                                <label for="product-color" class="form-label">Color</label>
                                <input type="text" id="product-color" name="color" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-weight">
                                <label for="product-weight" class="form-label">Weight (kg)</label>
                                <input type="number" id="product-weight" name="weight" class="form-control" step="0.01">
                            </div>
                        </div>

                        <!-- COLUNA DIREITA -->
                        <div class="col-md-6">
                            <div class="mb-3" id="form-group-dimensions">
                                <label for="product-dimensions" class="form-label">Dimensions</label>
                                <input type="text" id="product-dimensions" name="dimensions" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-processor">
                                <label for="product-processor" class="form-label">Processor</label>
                                <input type="text" id="product-processor" name="processor" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-screen">
                                <label for="product-screen" class="form-label">Screen</label>
                                <input type="text" id="product-screen" name="screen" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-ram_memory">
                                <label for="product-ram" class="form-label">RAM Memory</label>
                                <input type="text" id="product-ram" name="ram_memory" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-graphics_card">
                                <label for="product-graphics" class="form-label">Graphics Card</label>
                                <input type="text" id="product-graphics" name="graphics_card" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-storage">
                                <label for="product-storage" class="form-label">Storage</label>
                                <input type="text" id="product-storage" name="storage" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-keyboard">
                                <label for="product-keyboard" class="form-label">Keyboard</label>
                                <input type="text" id="product-keyboard" name="keyboard" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-os">
                                <label for="product-os" class="form-label">Operating System</label>
                                <input type="text" id="product-os" name="os" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-year">
                                <label for="product-year" class="form-label">Manufacture Year</label>
                                <input type="number" id="product-year" name="year" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- DESCRIÃ‡ÃƒO -->
                    <div class="mb-3 mt-4">
                        <label for="product-description" class="form-label">Description</label>
                        <textarea id="product-description" name="description" rows="5" class="form-control"
                            placeholder="Enter Description"></textarea>
                    </div>

                    <!-- IMAGENS -->
                    <div class="mb-4">
                        <label for="product-images" class="form-label">Product Images</label>
                        <div id="product-images" class="border border-secondary rounded p-3">
                            <!-- Image upload inputs are dynamically inserted here -->
                        </div>
                    </div>
                </form>

            </div>

        </div>

    </div>
    </div>

    <!-- Scripts -->
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/ui.js"></script>
    <script type="module">


        const setSaleForm = document.getElementById('set-sale-form');
        const setForSaleBtn = document.getElementById('set-for-sale-btn');
        const productList1 = document.getElementById('product-list');
        let selectedProductId = null;

        productList1.addEventListener('change', () => {
            const selected = Array.from(document.querySelectorAll('#product-list input[type="checkbox"]:checked'));

            // Disable button unless exactly 1 checkbox is selected
            setForSaleBtn.disabled = selected.length !== 1;

            if (selected.length === 1) {
                const checkbox = selected[0];
                // Get the closest row <tr> element for the checkbox
                const row = checkbox.closest('tr');
                if (row) {
                    selectedProductId = row.getAttribute('data-product-id');
                } else {
                    selectedProductId = null;
                }
            } else {
                selectedProductId = null;
            }
        });

        setForSaleBtn.addEventListener('click', () => {
            console.log('Set for sale button clicked');
            if (!selectedProductId) {
                console.warn('No product selected');
                return;
            }

            console.log('Selected product ID:', selectedProductId);

            const hiddenInput = document.getElementById('set-sale-product-id');
            if (!hiddenInput) {
                console.error('Hidden input #set-sale-product-id not found!');
                return;
            }
            hiddenInput.value = selectedProductId;
            console.log('Set hidden input value:', hiddenInput.value);

            const modalElement = document.getElementById('set-sale-modal');
            if (!modalElement) {
                console.error('Modal element #set-sale-modal not found!');
                return;
            }

            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            if (!modal) {
                console.error('Failed to get or create Bootstrap modal instance!');
                return;
            }

            modal.show();
            console.log('Modal shown');
        });

        setSaleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Get innerText of <td> element that comes after marked checkbox in #product-table for productId
            const productId = document.querySelector('#product-table input[type="checkbox"]:checked')?.closest('tr')?.querySelector('td:nth-child(2)')?.innerText;
            const price = document.getElementById('set-sale-price').value;

            try {
                const res = await fetch('/tt/sale/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: productId, price })
                });

                if (!res.ok) throw new Error((await res.json()).error || 'Unknown error');

                alert('Product set for sale!');
                bootstrap.Modal.getOrCreateInstance(document.getElementById('set-sale-modal')).hide();

                // * Send Notifications to Interested Clients *

                /**
                 * Fetches matching products from the `/tt` endpoint based on the provided product alert criteria.
                 *
                 * Converts the `watchData` object into query parameters for the backend product search.
                 * Fields such as `condition`, `year`, and `maxPrice` are included only if present.
                 *
                 * @async
                 * @function getProductAlertResults
                 * @param {Object} watchData - The user-defined alert data containing product preferences.
                 * @param {string} [watchData.product_model] - Name or model of the product to watch.
                 * @param {string} [watchData.product_condition] - Desired condition (e.g., "Like New", "Excellent").
                 * @param {string} [watchData.category] - Product category (e.g., "Smartphones").
                 * @param {string} [watchData.brand] - Brand of the product (e.g., "Apple").
                 * @param {string} [watchData.processor] - Processor type (e.g., "A13 Bionic").
                 * @param {string} [watchData.color] - Preferred product color.
                 * @param {string} [watchData.screen] - Screen type or size.
                 * @param {string} [watchData.storage] - Storage capacity (e.g., "128GB").
                 * @param {string} [watchData.os] - Operating system (e.g., "Android").
                 * @param {string|number} [watchData.year] - Manufacturing year of the product.
                 * @param {string|number} [watchData.max_price] - Maximum acceptable price.
                 * @returns {Promise<Object[]>} - A promise that resolves to an array of matching product objects.
                 */
                async function getProductAlertResults(watchData) {
                    try {
                        // Prepare alert criteria
                        const alertCriteria = {
                            name: watchData.product_model,
                            condition: watchData.product_condition || "",
                            category: watchData.category,
                            brand: watchData.brand,
                            processor: watchData.processor,
                            color: watchData.color,
                            screen: watchData.screen,
                            storage: watchData.storage,
                            os: watchData.os,
                            year: watchData.year || "",
                            maxPrice: watchData.max_price || "",
                        };

                        const productsResponse = await fetch(`/tt?${new URLSearchParams(alertCriteria)}`);

                        if (!productsResponse.ok) {
                            throw new Error(`HTTP error! status: ${productsResponse.status}`);
                        }

                        const data = await productsResponse.json();
                        return data;

                    } catch (error) {
                    }
                }

                try {
                    const interestsRes = await fetch('/ttuser/interests/');
                    if (!interestsRes.ok) throw new Error(`Failed to fetch interests: ${interestsRes.status}`);

                    const interests = await interestsRes.json();

                    for (const interest of interests) {
                        const results = await getProductAlertResults(interest);
                        if (results.length > 0) {
                            await fetch(`/ttuser/interest/addNotification/${interest.id}`);
                        }
                    }
                } catch (error) {
                    console.error('Error updating user alerts:', error);
                }

                fetchAdminProducts(filters);
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        const filters = {
            name: document.getElementById('search-bar').value.trim(),
            condition: document.getElementById('condition-filter').value,
            availability: document.getElementById('availability-filter').value
        };

        let productList = []; // Persist across modal openings
        let totalPrice = 0;

        window.showAddProductForm = showAddProductForm; // expose globally


        window.toggleAllProducts = function (source) {
            const checkboxes = document.querySelectorAll('#product-list .product-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = source.checked;
            });
        };

        const categoryFieldMap = {
            'Smartphones': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'processor', 'screen', 'ram_memory', 'storage', 'os', 'year'
            ],
            'Laptops & PCs': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'processor', 'screen', 'ram_memory', 'graphics_card',
                'storage', 'keyboard', 'os', 'year'
            ],
            'Smartwatches': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'year'
            ],
            'Gaming': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'storage', 'year'
            ],
            'TVs & Monitors': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'screen', 'year'
            ],
            'Audio': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'year'
            ],
            'Tablets': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'processor', 'screen', 'ram_memory', 'storage', 'os', 'year'
            ],
            'Cameras': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'processor', 'screen', 'storage', 'os', 'year'
            ],
            'Accessories': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'year'
            ],
            'Home Appliances': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'year'
            ],
            'Other': [
                'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                'weight', 'dimensions', 'year'
            ]
        };





        function updateVisibleFields(category) {
            const allFields = [
                'name',
                'product_condition',
                'availability',
                'category',
                'brand',
                'model_code',
                'color',
                'weight',
                'dimensions',
                'processor',
                'screen',
                'ram_memory',
                'graphics_card',
                'storage',
                'keyboard',
                'os',
                'year'
            ];


            allFields.forEach(field => {
                const group = document.getElementById(`form-group-${field}`);
                if (group) group.classList.add('d-none');
            });

            const visibleFields = categoryFieldMap[category] || [];
            visibleFields.forEach(field => {
                const group = document.getElementById(`form-group-${field}`);
                if (group) group.classList.remove('d-none');
            });
        }



        document.getElementById('product-category').addEventListener('change', function () {
            const selectedCategory = this.value;
            updateVisibleFields(selectedCategory);
        });

        // Inicializa no carregamento
        const initialCategory = document.getElementById('product-category').value;
        updateVisibleFields(initialCategory);



        document.getElementById("register-sale").addEventListener("click", async () => {
            const selectedProducts = Array.from(document.querySelectorAll('#product-list input[type="checkbox"]:checked'));
            const list = document.querySelector('#sale-product-list');

            if (selectedProducts.length === 0 && productList.length === 0) {
                list.innerHTML = '<p class="text-muted">No products selected.</p>';
            }

            for (const checkbox of selectedProducts) {
                const row = checkbox.closest('tr');
                const productId = row.getAttribute('data-product-id');

                if (productList.some(p => p.id === productId)) continue;

                try {
                    const res = await fetch(`/tt/product/${productId}`);
                    if (!res.ok) throw new Error('Product not found');

                    const product = await res.json();

                    if (!product.availability) {
                        alert(`Product ${product.id} is not available for sale.`);
                        continue;
                    }

                    productList.push(product);
                    totalPrice += parseFloat(product.price || 0);

                    appendProductToList(product);
                } catch (err) {
                    console.error(err);
                    alert(err.message || 'Failed to fetch product.');
                }
            }

            updateTotalAndPayPal();
            bootstrap.Modal.getOrCreateInstance(document.getElementById('sale-modal')).show();
        });

        function appendProductToList(product) {
            const list = document.querySelector('#sale-product-list');
            if (list.querySelector('.text-muted')) list.querySelector('.text-muted').remove();

            const item = document.createElement('li');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
        <div class="d-flex align-items-center">
            <img src="../media/images/products/${product.images["1"] || 'default.jpg'}"
                alt="Product Image" class="me-2"
                style="width: 50px; height: 50px; object-fit: contain; border-radius: 0.25rem; zoom: 1.2;">
            <div>
                <strong>${product.name}</strong><br>
                <small>ID: ${product.id}</small>
            </div>
        </div>
        <span>â‚¬${parseFloat(product.price).toFixed(2)}</span>
    `;
            list.appendChild(item);
        }

        function updateTotalAndPayPal() {
            document.querySelector('#sale-total-price').textContent = `â‚¬${totalPrice.toFixed(2)}`;
            document.getElementById('paypal').classList.replace('d-none', 'd-block');
            renderPayPal();
        }

        // Reset Button Logic
        const footer = document.querySelector("#sale-modal .modal-footer");
        if (!footer.querySelector('.btn-outline-danger')) {
            const resetBtn = document.createElement("button");
            resetBtn.type = "button";
            resetBtn.className = "btn btn-outline-danger";
            resetBtn.textContent = "Reset Product Sale";
            footer.appendChild(resetBtn);

            resetBtn.addEventListener("click", () => {
                productList = [];
                totalPrice = 0;
                document.querySelector('#sale-product-list').innerHTML = `<p class="text-muted">Products will appear here.</p>`;
                document.querySelector("#sale-total-price").textContent = "â‚¬0.00";
                document.getElementById("paypal").innerHTML = "";
                document.getElementById("paypal").classList.add("d-none");
            });
        }

        // Add-by-ID Button Logic
        const body = document.querySelector("#sale-modal .modal-body");
        const addBtn = body.querySelector('.btn-outline-primary');
        const input = body.querySelector('#sale-product-id');

        if (!addBtn.dataset.bound) {
            addBtn.dataset.bound = 'true';
            addBtn.addEventListener('click', async () => {
                const productId = input.value.trim();
                if (!productId) return;

                try {
                    const res = await fetch(`/tt/product/${productId}`);
                    if (!res.ok) throw new Error('Product not found');

                    const product = await res.json();
                    if (productList.some(p => p.id === product.id)) {
                        alert("Product already added.");
                        return;
                    }
                    if (!product.availability) {
                        alert("This product is not available for sale.");
                        return;
                    }

                    productList.push(product);
                    totalPrice += parseFloat(product.price || 0);
                    appendProductToList(product);
                    updateTotalAndPayPal();

                    input.value = '';
                } catch (err) {
                    alert(err.message || 'Failed to fetch product');
                }
            });
        }

        // PayPal Render Logic
        function renderPayPal() {
            const paypalContainer = document.getElementById("paypal");
            paypalContainer.innerHTML = "";

            if (!productList.length || !totalPrice || isNaN(totalPrice)) {
                paypalContainer.classList.add("d-none");
                return;
            }

            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    borderRadius: 10,
                    label: 'paypal'
                },
                createOrder: (data, actions) => actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: String(totalPrice.toFixed(2))
                        }
                    }]
                }),
                onError: (err) => {
                    showMessage("Payment Declined", "Your payment was declined or cancelled.", "danger");
                },
                onApprove: async (data, actions) => {
                    const cartProductIds = productList.map(p => p.id);

                    try {
                        const availabilityCheck = await fetch('/tttransaction/product-availability', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ productIds: cartProductIds })
                        });

                        const checkData = await availabilityCheck.json();
                        if (!checkData.allAvailable) {
                            checkData.unavailable.forEach(id => {
                                const row = document.querySelector(`[data-product-id="${id}"]`);
                                if (row) row.classList.add('table-danger');
                            });
                            throw new Error("Some items are no longer available.");
                        }

                        const details = await actions.order.capture();
                        const shipping = details.purchase_units[0].shipping;
                        const shippingAddress = {
                            address: (shipping.address.address_line_1 + " " + (shipping.address.address_line_2 || "")).trim(),
                            postal_code: shipping.address.postal_code.trim(),
                            city: (shipping.address.admin_area_2 + " " + shipping.address.admin_area_1).trim(),
                            country: shipping.address.country_code.trim()
                        };

                        const saleResponse = await fetch('/tttransaction/sales/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                client: loggedInUser.email,
                                transaction_value: parseFloat(totalPrice),
                                is_online: true,
                                order_number: details.id,
                                shipping_address: shippingAddress.address,
                                shipping_postal_code: shippingAddress.postal_code,
                                shipping_city: shippingAddress.city,
                                shipping_country: shippingAddress.country,
                                products: cartProductIds,
                                employee: null,
                                store: null,
                            })
                        });

                        if (!saleResponse.ok) throw new Error("Failed to store transaction.");

                        // Reset and show success
                        productList = [];
                        totalPrice = 0;
                        document.getElementById("sale-product-list").innerHTML = "";
                        document.querySelector("#sale-total-price").textContent = "â‚¬0.00";
                        paypalContainer.classList.add("d-none");

                        document.getElementById("paymentInterface").innerHTML = `
                    <div class="d-flex flex-column align-items-center my-5 justify-content-center" style="min-height: 60vh;">
                        <div class="text-success mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.97 10.03a.75.75 0 0 0 1.08-.02l3.992-4.99a.75.75 0 1 0-1.16-.96L7.477 8.417 5.383 6.323a.75.75 0 0 0-1.06 1.06l2.647 2.647z"/>
                            </svg>
                        </div>
                        <h2 class="text-center mb-3">Your order is on its way!</h2>
                        <p class="text-muted mb-4">Order Code: <code>${details.id}</code></p>
                        <p class="text-center mb-4">Thank you for your purchase!</p>
                        <a href="/" class="btn btn-success btn-lg">Thrift More</a>
                    </div>`;
                    } catch (err) {
                        console.error(err);
                        showMessage("Purchase Unsuccessful", err.message || "An error occurred.", "danger");
                    }
                }
            }).render('#paypal');
        }



        function animateListItems(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;

            const items = container.children;

            Array.from(items).forEach((item, index) => {
                item.classList.add('animate-item');
                item.style.animationDelay = `${index * 70}ms`;
            });
        }


        async function fetchConditions() {
            try {
                const res = await fetch('/tt/product');
                const products = await res.json();
                const uniqueConditions = [...new Set(products.map(p => p.product_condition))];
                const conditionFilter = document.getElementById('condition-filter');
                conditionFilter.innerHTML = '<option value="">All Conditions</option>';
                uniqueConditions.forEach(condition => {
                    if (condition) {
                        const option = document.createElement('option');
                        option.value = condition;
                        option.textContent = condition;
                        conditionFilter.appendChild(option);
                    }
                });
            } catch (err) {
                console.error('Error fetching conditions:', err);
            }
        }

        //pagination
        import { setupPagination } from '../scripts/adminProductsPagination.js';

        let selectedProductIds = [];

        function renderProductRow(product) {
            const price = priceMap[product.id];
            const productRow = document.createElement('tr');
            productRow.classList.add('cursor-pointer');
            productRow.dataset.productId = product.id;

            // Row click: ignore checkbox clicks
            productRow.addEventListener('click', (event) => {
                if (event.target.type !== 'checkbox') {
                    viewProductDetails(product.id);
                }
            });

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.classList.add('product-checkbox');
            checkbox.addEventListener('change', (event) => {
                const productId = product.id;
                if (event.target.checked) {
                    selectedProductIds.push(productId);
                } else {
                    selectedProductIds = selectedProductIds.filter(id => id !== productId);
                }
            });

            productRow.innerHTML = `
                <td><input type="checkbox" class="product-checkbox"></td>
                <td>${product.id}</td>
                <td class="product-name">${product.name}</td>
                <td class="product-price">${price !== null && price !== undefined ? `â‚¬${parseFloat(price).toFixed(2)}` : '-'}</td>
                <td>${product.category || 'N/A'}</td>
                <td>${product.product_condition || 'N/A'}</td>
                <td>${product.availability ? 'Available' : 'Unavailable'}</td>
                <td>${price ? 'Up for Sale' : 'Not for Sale'}</td>
            `;

            return productRow;
        }

        let priceMap = {};

        async function fetchAdminProducts(filters = {}) {
            try {
                const params = new URLSearchParams(filters);
                const response = await fetch(`/tt/product?${params.toString()}`);
                const products = await response.json();

                const priceResponse = await fetch('/tt');
                const priceData = await priceResponse.json();
                priceMap = {};
                priceData.forEach(item => priceMap[item.id] = item.price);

                setupPagination(products, 'product-list', 'pagination-controls', renderProductRow);

                animateListItems('#product-list');
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        }

        // Call on page load
        fetchAdminProducts(filters);



        function showAddProductForm() {
            document.getElementById('product-table').classList.add('d-none');
            document.getElementById('filters-row').classList.add('d-none');
            document.getElementById('top-buttons').classList.add('d-none');
            document.getElementById('add-product-form').classList.remove('d-none');

            // Reset form
            const form = document.getElementById('productForm');
            form.reset();
            [...form.elements].forEach(el => el.disabled = false);

            // Reset buttons
            const cancelBtn = document.querySelector('#add-product-form .btn-light');
            const submitBtn = document.querySelector('#add-product-form .btn-success');

            cancelBtn.textContent = 'Cancel';
            submitBtn.classList.remove('d-none');

            // Replace image upload area with basic input rows
            const dropzone = document.getElementById('product-images');
            dropzone.innerHTML = `
                <div class="mb-2"><small class="text-muted">Upload up to 5 images and optionally set their order.</small></div>
                <div id="image-input-group" class="d-flex flex-column gap-2"></div>
            `;

            const imageInputGroup = document.getElementById('image-input-group');
            for (let i = 1; i <= 5; i++) {
                const row = document.createElement("div");
                row.className = "d-flex align-items-center gap-2";

                const fileInput = document.createElement("input");
                fileInput.type = "file";
                fileInput.accept = "image/*";
                fileInput.name = "images[]";
                fileInput.className = "form-control";

                const orderInput = document.createElement("input");
                orderInput.type = "number";
                orderInput.min = "1";
                orderInput.max = "5";
                orderInput.placeholder = "Order";
                orderInput.name = "orders[]";
                orderInput.className = "form-control";
                orderInput.style.maxWidth = "100px";

                row.appendChild(fileInput);
                row.appendChild(orderInput);
                imageInputGroup.appendChild(row);
            }
        }




        window.hideAddProductForm = function () {
            document.getElementById('product-table').classList.remove('d-none');
            document.getElementById('filters-row').classList.remove('d-none');
            document.getElementById('top-buttons').classList.remove('d-none');
            document.getElementById('add-product-form').classList.add('d-none');
        };


        async function viewProductDetails(id) {

            try {
                const res = await fetch(`/tt/product/${id}`);
                if (!res.ok) {
                    return alert('Failed to fetch product details.');
                }

                const product = await res.json();
                console.log('Fetched product data:', product); // ðŸ‘ˆ Add this line for debugging

                showAddProductForm(); // Reuse the product form layout

                // === Fill form fields ===
                const form = document.getElementById('productForm');
                if (form.elements['name']) form.elements['name'].value = product.name || '';
                if (form.elements['store_nipc']) form.elements['store_nipc'].value = product.store_nipc || '';
                if (form.elements['product_condition']) form.elements['product_condition'].value = product.product_condition || '';
                if (form.elements['availability']) form.elements['availability'].value = product.availability || '';
                if (form.elements['description']) form.elements['description'].value = product.description || '';
                if (form.elements['category']) form.elements['category'].value = product.category || '';
                if (form.elements['brand']) form.elements['brand'].value = product.brand || '';
                if (form.elements['model_code']) form.elements['model_code'].value = product.model_code || '';
                if (form.elements['color']) form.elements['color'].value = product.color || '';
                if (form.elements['weight']) form.elements['weight'].value = product.weight || '';
                if (form.elements['dimensions']) form.elements['dimensions'].value = product.dimensions || '';
                if (form.elements['processor']) form.elements['processor'].value = product.processor || '';
                if (form.elements['screen']) form.elements['screen'].value = product.screen || '';
                if (form.elements['ram_memory']) form.elements['ram_memory'].value = product.ram_memory || '';
                if (form.elements['graphics_card']) form.elements['graphics_card'].value = product.graphics_card || '';
                if (form.elements['storage']) form.elements['storage'].value = product.storage || '';
                if (form.elements['keyboard']) form.elements['keyboard'].value = product.keyboard || '';
                if (form.elements['os']) form.elements['os'].value = product.os || '';
                if (form.elements['year']) form.elements['year'].value = product.year || '';



                // === Disable fields (read-only mode) ===
                [...form.elements].forEach(el => el.disabled = true);

                // === Adjust buttons ===
                const cancelBtn = document.querySelector('#add-product-form .btn-light');
                const submitBtn = document.querySelector('#add-product-form .btn-success');
                cancelBtn.textContent = 'Back';
                submitBtn.classList.add('d-none');

                // === Setup image preview ===
                const dropzone = document.getElementById('product-images');
                dropzone.innerHTML = '';

                const images = product.images || {};
                const imageBasePath = "../media/images/products/";
                const selectedImages = [];
                const allThumbnails = [];

                Object.entries(images).forEach(([order, filename]) => {
                    if (filename) {
                        allThumbnails.push({ order, filename });
                        if (order !== 'null' && order !== null && order !== '' && !isNaN(order)) {
                            selectedImages.push(filename);
                        }
                    }
                });

                if (selectedImages.length > 0) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'w-100';

                    // === Carousel ===
                    const carouselWrapper = document.createElement('div');
                    carouselWrapper.className = 'position-relative mb-3';
                    carouselWrapper.style.height = '280px';

                    const carousel = document.createElement('div');
                    carousel.id = 'product-carousel';
                    carousel.className = 'carousel slide h-100';
                    carousel.setAttribute('data-bs-ride', 'carousel');

                    const inner = document.createElement('div');
                    inner.className = 'carousel-inner h-100 w-100 bg-white rounded text-center overflow-hidden';
                    inner.style.position = 'relative';

                    selectedImages.forEach((filename, index) => {
                        const item = document.createElement('div');
                        item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                        item.style.height = '100%';

                        const img = document.createElement('img');
                        img.src = imageBasePath + filename;
                        img.className = 'img-fluid h-100';
                        img.style.objectFit = 'contain';
                        img.style.cursor = 'zoom-in';

                        img.addEventListener('click', () => {
                            let modalEl = document.getElementById("image-popup");
                            if (!modalEl) {
                                modalEl = document.createElement("div");
                                modalEl.className = "modal fade";
                                modalEl.id = "image-popup";
                                modalEl.tabIndex = -1;
                                modalEl.innerHTML = `
                            <div class="modal-dialog modal-dialog-centered" style="zoom: 1.3;">
                                <div class="modal-content border-0 text-center rounded bg-white m-auto">
                                    <button type="button" class="btn-close position-absolute top-0 end-0 mt-3 me-3"
                                        data-bs-dismiss="modal" aria-label="Close"></button>
                                    <img class="img-fluid p-3 border-top shadow-lg" style="margin-top: 3.5rem;">
                                </div>
                            </div>`;
                                document.body.appendChild(modalEl);
                            }

                            modalEl.querySelector("img").src = img.src;
                            bootstrap.Modal.getOrCreateInstance(modalEl).show();
                        });

                        item.appendChild(img);
                        inner.appendChild(item);
                    });

                    carousel.appendChild(inner);

                    if (selectedImages.length > 1) {
                        carousel.innerHTML += `
                    <button class="carousel-control-prev" type="button" data-bs-target="#product-carousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon bg-dark rounded-circle" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#product-carousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon bg-dark rounded-circle" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                `;
                    }

                    carouselWrapper.appendChild(carousel);
                    wrapper.appendChild(carouselWrapper);

                    // === Thumbnails ===
                    const thumbRow = document.createElement('div');
                    thumbRow.id = 'thumbnail-row';
                    thumbRow.className = 'd-flex flex-wrap gap-2 justify-content-center mt-2';

                    allThumbnails.forEach(({ filename, order }) => {
                        const thumb = document.createElement('img');
                        thumb.src = imageBasePath + filename;
                        thumb.className = 'rounded border';
                        thumb.style.height = '60px';
                        thumb.style.cursor = 'pointer';

                        if (selectedImages.includes(filename)) {
                            const slideIndex = selectedImages.indexOf(filename);
                            thumb.dataset.bsTarget = '#product-carousel';
                            thumb.dataset.bsSlideTo = slideIndex;
                            if (slideIndex === 0) thumb.classList.add('border-primary', 'border-2');
                        }

                        thumbRow.appendChild(thumb);
                    });

                    wrapper.appendChild(thumbRow);
                    dropzone.appendChild(wrapper);

                    // Highlight active thumbnail
                    document.getElementById('product-carousel').addEventListener('slid.bs.carousel', function (e) {
                        const thumbs = thumbRow.querySelectorAll('img');
                        thumbs.forEach(t => t.classList.remove('border-primary', 'border-2'));

                        const filename = selectedImages[e.to];
                        const activeThumb = Array.from(thumbs).find(t => t.src.includes(filename));
                        if (activeThumb) activeThumb.classList.add('border-primary', 'border-2');
                    });

                } else {
                    dropzone.innerHTML = `<p class="mt-5">No images available for this product</p>`;
                }
            } catch (err) {
                console.error(err);
                alert('Error fetching product details.');
            }
        }



        document.addEventListener('DOMContentLoaded', () => {
            fetchConditions();
            fetchAdminProducts(filters);

            document.getElementById('filter-btn').addEventListener('click', () => {
                const filters = {
                    name: document.getElementById('search-bar').value.trim(),
                    condition: document.getElementById('condition-filter').value,
                    availability: document.getElementById('availability-filter').value
                };
                fetchAdminProducts(filters);
            });



            function updatePreview(files) {
                previewContainer.innerHTML = '';
                [...files].forEach(file => {
                    if (!file.type.startsWith('image/')) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'rounded border';
                        img.style.height = '60px';
                        img.style.objectFit = 'cover';
                        previewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }


            document.getElementById('productForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const form = e.target;
                const data = {};

                const fields = [
                    'name', 'store_nipc', 'product_condition', 'availability', 'description', 'category',
                    'brand', 'model_code', 'color', 'weight', 'dimensions', 'processor',
                    'screen', 'ram_memory', 'graphics_card', 'storage', 'keyboard', 'os', 'year'
                ];

                fields.forEach(field => {
                    const el = form.elements[field];
                    if (el) {
                        if (el.type === 'checkbox') {
                            data[field] = el.checked;
                        } else if (el.type === 'number') {
                            data[field] = el.value ? parseFloat(el.value) : null;
                        } else {
                            data[field] = el.value || null;
                        }
                    }
                });

                data.availability = 'true' ? 1 : 0;

                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                if (loggedInUser && loggedInUser.store) {
                    data.store_nipc = loggedInUser.store;
                } else {
                    alert('No store information found for the logged-in user.');
                    return;
                }
                try {
                    // Submit product
                    const res = await fetch('/tt/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!res.ok) {
                        const err = await res.json();
                        alert('Failed to add product: ' + err.error);
                        return;
                    }

                    const addedProduct = await res.json();

                    // Collect image filenames and orders
                    const rows = document.querySelectorAll('#image-input-group > div');
                    const formData = new FormData();

                    formData.append('product_id', addedProduct.id);

                    const orders = [];

                    rows.forEach((row, idx) => {
                        const fileInput = row.querySelector('input[type="file"]');
                        const orderInput = row.querySelector('input[type="number"]');

                        if (fileInput.files[0]) {
                            const file = fileInput.files[0];
                            formData.append('images', file); // append each file
                            const imageOrder = orderInput.value || (idx + 1);
                            orders.push(parseInt(imageOrder));
                        }
                    });

                    formData.append('orders', JSON.stringify(orders)); // send orders array as string

                    const imgRes = await fetch('/tt/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!imgRes.ok) {
                        const err = await imgRes.json();
                        alert('Images upload failed: ' + err.error);
                        return;
                    }

                    alert('Product added successfully!');
                    document.getElementById('add-product-form').classList.add('d-none');
                    document.getElementById('product-table').classList.remove('d-none');
                    document.getElementById('filters-row').classList.remove('d-none');
                    document.getElementById('top-buttons').classList.remove('d-none');

                    // Optionally reload table
                    fetchAdminProducts(filters);

                } catch (err) {
                    console.error(err);
                    alert('Error submitting product.');
                }
            });

            document.getElementById('delete-selected').addEventListener('click', async function () {
                const selectedProducts = Array.from(document.querySelectorAll('#product-list input[type="checkbox"]:checked'));


                if (selectedProducts.length === 0) {
                    alert('No products selected.');
                    return;
                }

                if (!confirm(`Are you sure you want to delete ${selectedProducts.length} product(s)?`)) {
                    return;
                }

                for (const checkbox of selectedProducts) {
                    const row = checkbox.closest('tr');
                    const productId = row?.getAttribute('data-product-id');

                    if (!productId) {
                        console.warn('Row missing data-product-id');
                        continue;
                    }

                    try {
                        const res = await fetch(`/tt/remove/${productId}`, { method: 'DELETE' });

                        const responseText = await res.text();
                        if (!res.ok) {
                            console.error(`Failed to delete product ${productId}:`, responseText);
                        } else {
                            console.log(`Successfully deleted product ${productId}:`, responseText);
                        }
                    } catch (err) {
                        console.error(`Error deleting product ${productId}:`, err);
                    }
                }

                alert('Selected products deleted.');

                if (typeof fetchAdminProducts === 'function') {
                    console.log('Refreshing product list...');
                    fetchAdminProducts(filters);
                } else {
                    console.warn('fetchAdminProducts is not defined.');
                }
            });
        });
    </script>
    <!-- Scripts -->

</body>

</html>