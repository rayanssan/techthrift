<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechThrift Partners - Orders</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap -->
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <script src="https://kit.fontawesome.com/05e3d8d374.js" crossorigin="anonymous"></script>
    <!-- Font Awesome -->
    <!-- PayPal API -->
    <script
        src="https://www.paypal.com/sdk/js?client-id=AU12GNf0wBJuuthVz7Xw9J7oiobcBjeAVYpoxEuhpGQKtOlKVYsn3nIbTSXOgNfRTdZrONxCW1Cm6gtB&currency=EUR&locale=en_PT&components=buttons,applepay"></script>
    <!-- PayPal API -->
    <!-- Sidebar Script -->
    <script src="../scripts/sidebar.js"></script>
    <!-- Sidebar Script -->
    <!-- Stylesheets -->
    <link rel="stylesheet" href="../styles/stylesheet.css">
    <link rel="stylesheet" href="../styles/adminstyles.css">
    <style>
        .nav-tabs .nav-link {
            border: none;
            position: relative;
            font-weight: bold;
        }

        .nav-tabs .nav-link.active::after {
            content: "";
            position: absolute;
            left: 0;
            bottom: -2px;
            width: 100%;
            height: 3px;
            background-color: rgb(114, 114, 121);
            transition: width 0.3s ease-in-out;
        }
    </style>
    <!-- Stylesheets -->
</head>

<body>
    <!-- Header -->
    <header class="p-3 border-bottom bg-white">
        <div class="d-flex justify-content-between container">
            <div class="row align-items-center gap-3">
                <!-- Left elements -->
                <div class="col-lg-5 col-md-12 col-12 d-flex w-auto align-items-center">
                    <a id="header-brand" href="/adminDashboard" class="ms-1">
                        <img alt="TechThrift's logo" src="../media/images/logo_hor_partners.png">
                    </a>
                </div>
                <!-- Left elements -->
            </div>
            <div class="d-flex flex-wrap justify-content-center 
                    align-items-center gap-1 ms-auto">
                <a href="/authentication" id="username" class="border 
                rounded py-1 px-3 nav-link d-flex h-auto
                align-self-center
                align-items-center btn btn-light">
                    <i class="fas fa-user-alt m-1 me-md-2"></i>
                    <p class="d-none d-md-block mb-0">···</p>
                </a>
                <button id="toggle-mode"
                    class="btn border rounded py-1 px-3 nav-link d-flex align-items-center btn btn-light">
                    &nbsp;<i id="mode-icon" class="fas fa-moon"></i>&nbsp;
                </button>
            </div>
        </div>
    </header>
    <!-- Header -->

    <div class="d-flex">
        <div class="sidebar p-3 bg-light vh-100" style="width: 250px;">
            <h4 class="text-center">Control Panel</h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminDashboard"><i
                            class="fas fa-tachometer-alt me-2"></i>Start</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminProducts"><i class="fas fa-box me-2"></i>Products</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminOrders"><i class="fas fa-shopping-cart me-2"></i>Orders</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminDonations"><i
                            class="fas fa-hand-holding-heart me-2"></i>Donations</a>
                </li>
            </ul>
        </div>

        <div class="content p-4" style="flex-grow: 1;">
            <div id="ordersTableContainer">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Orders</h2>
                    <button class="btn btn-success" 
                    onclick='showOrderForm();
                    document.getElementById("repair-product-name").value = "";
                    document.getElementById("sell-product-name").value = ""'>
                    <i class="fas fa-plus me-1"></i> Add Order</button>
                </div>
                <div class="table-responsive" id="order-table">
                    <div class="rounded-3 border overflow-auto">
                        <table class="table table-borderless table-striped table-hover rounded-3">
                            <thead class="table-light">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Client</th>
                                    <th>Type</th>
                                    <th>Items</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="order-list" class="animate-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- Repair Order Form -->
            <div id="orderFormContainer" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Add Order</h2>
                    <button class="btn btn-primary me-2" onclick="showOrdersTable()">Cancel</button>
                </div>
                <ul class="nav nav-tabs" id="orderTypeTabs">
                    <li class="nav-item">
                        <a class="nav-link" id="sellTab" onclick="switchOrderType('sell')">Client Sell Order</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" id="repairTab" onclick="switchOrderType('repair')">Product Repair
                            Order</a>
                    </li>
                </ul>

                <form id="orderForm" class="mt-3" novalidate>
                    <!-- Repair Form Fields -->
                    <div id="repairFields">
                        <div class="mb-3">
                            <label for="repair-client" class="form-label">Client Email</label>
                            <input class="form-control" id="repair-client" name="repair-client"
                                placeholder="Enter Client Email" />
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="non-registered-checkbox" />
                                <label class="form-check-label" for="non-registered-checkbox">
                                    Non-registered client
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="repair-product-name" class="form-label">Product</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="repair-product-name"
                                    placeholder="No product selected" readonly>
                                <input type="hidden" id="repair-product-id" name="repair-product-id" required>
                                <button type="button" class="btn btn-outline-secondary"
                                    onclick="openProductForm('repair')">Add Product</button>
                            </div>
                        </div>

                        <!-- Select Repair Parts -->
                        <div class="mb-3">
                            <label class="form-label">Repair Parts</label>
                            <button type="button" class="btn btn-outline-primary w-100"
                                onclick="openRepairPartsSelector()">Select Parts</button>
                            <ul id="selected-repair-parts" class="list-group mt-2"></ul>
                        </div>

                        <!-- Profit Margin -->
                        <div class="mb-3">
                            <label for="profit-percentage" class="form-label">Profit Margin</label>
                            <select class="form-select" id="profit-percentage">
                                <option value="0">No Profit</option>
                                <option value="0.10">10%</option>
                                <option value="0.20">20%</option>
                                <option value="0.30">30%</option>
                                <option value="0.50">50%</option>
                                <option value="0.70">70%</option>
                                <option value="1">100%</option>
                            </select>
                        </div>

                        <!-- Final Price Display -->
                        <div class="mb-3">
                            <label class="form-label">Final Repair Price</label>
                            <input type="text" class="form-control" id="repair-price">
                        </div>

                        <div id="paypal">
                        </div>
                    </div>

                    <div id="sellFields" style="display: none;">
                        <div class="mb-3">
                            <label for="sell-product-name" class="form-label">Product</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="sell-product-name"
                                    placeholder="No product selected" readonly>
                                <input type="hidden" id="sell-product-id" required>
                                <button type="button" class="btn btn-outline-secondary"
                                    onclick="openProductForm('sell')">Add Product</button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="purchase-product-seller-email" class="form-label">Seller Email</label>
                            <input type="email" class="form-control" id="purchase-product-seller-email"
                                name="seller_email" placeholder="Enter Seller Email" required>
                        </div>
                        <div class="mb-3">
                            <label for="purchase-price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="purchase-price" name="purchase_price"
                                placeholder="Enter Price" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100" onclick="disableHiddenFields()">Submit
                            Order</button>
                    </div>
                </form>
            </div>


            <div id="add-product-form" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Add New Product</h2>
                    <div>
                        <button class="btn btn-light me-2" onclick="hideAddProductForm()">Cancel</button>
                        <button type="submit" class="btn btn-success" form="productForm">Submit Product</button>
                    </div>
                </div>

                <form id="productForm" enctype="multipart/form-data">
                    <div class="row">
                        <!-- COLUNA ESQUERDA -->
                        <div class="col-md-6">
                            <div class="mb-3" id="form-group-name">
                                <label for="product-name" class="form-label">Product Name</label>
                                <input type="text" id="product-name" name="name" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="product-condition" class="form-label">Condition</label>
                                <select id="product-condition" name="product_condition" class="form-select" required>
                                    <option>Like New</option>
                                    <option>Excellent</option>
                                    <option>Good</option>
                                    <option>Needs Repair</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="product-category" class="form-label">Category</label>
                                <select id="product-category" name="category" class="form-select" required>
                                    <option>Smartphones</option>
                                    <option>Laptops & PCs</option>
                                    <option>Smartwatches</option>
                                    <option>Gaming</option>
                                    <option>TVs & Monitors</option>
                                    <option>Audio</option>
                                    <option>Tablets</option>
                                    <option>Cameras</option>
                                    <option>Accessories</option>
                                    <option>Home Appliances</option>
                                    <option>Other</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="product-brand" class="form-label">Brand</label>
                                <input list="brands" id="product-brand" name="brand" class="form-control"
                                    placeholder="Select or type a brand" required />
                                <datalist id="brands">
                                    <option value="Apple"></option>
                                    <option value="Samsung"></option>
                                    <option value="Dell"></option>
                                    <option value="HP"></option>
                                    <option value="Microsoft"></option>
                                    <option value="Xiaomi"></option>
                                    <option value="LG"></option>
                                    <option value="Sony"></option>
                                    <option value="Fitbit"></option>
                                    <option value="Nintendo"></option>
                                    <option value="Razer"></option>
                                    <option value="Bose"></option>
                                    <option value="GoPro"></option>
                                    <option value="Canon"></option>
                                    <option value="Other"></option>
                                </datalist>
                            </div>

                            <div class="mb-3" id="form-group-model_code">
                                <label for="product-model-code" class="form-label">Model Code</label>
                                <input type="text" id="product-model-code" name="model_code" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-color">
                                <label for="product-color" class="form-label">Color</label>
                                <input type="text" id="product-color" name="color" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-weight">
                                <label for="product-weight" class="form-label">Weight (kg)</label>
                                <input type="number" id="product-weight" name="weight" class="form-control" step="0.01">
                            </div>
                        </div>

                        <!-- COLUNA DIREITA -->
                        <div class="col-md-6">
                            <div class="mb-3" id="form-group-dimensions">
                                <label for="product-dimensions" class="form-label">Dimensions</label>
                                <input type="text" id="product-dimensions" name="dimensions" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-processor">
                                <label for="product-processor" class="form-label">Processor</label>
                                <input type="text" id="product-processor" name="processor" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-screen">
                                <label for="product-screen" class="form-label">Screen</label>
                                <input type="text" id="product-screen" name="screen" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-ram_memory">
                                <label for="product-ram" class="form-label">RAM Memory</label>
                                <input type="text" id="product-ram" name="ram_memory" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-graphics_card">
                                <label for="product-graphics" class="form-label">Graphics Card</label>
                                <input type="text" id="product-graphics" name="graphics_card" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-storage">
                                <label for="product-storage" class="form-label">Storage</label>
                                <input type="text" id="product-storage" name="storage" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-keyboard">
                                <label for="product-keyboard" class="form-label">Keyboard</label>
                                <input type="text" id="product-keyboard" name="keyboard" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-os">
                                <label for="product-os" class="form-label">Operating System</label>
                                <input type="text" id="product-os" name="os" class="form-control">
                            </div>

                            <div class="mb-3" id="form-group-year">
                                <label for="product-year" class="form-label">Manufacture Year</label>
                                <input type="number" id="product-year" name="year" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- DESCRIÇÃO -->
                    <div class="mb-3 mt-4">
                        <label for="product-description" class="form-label">Description</label>
                        <textarea id="product-description" name="description" rows="5" class="form-control"
                            placeholder="Enter Description" required></textarea>
                    </div>

                    <!-- IMAGENS -->
                    <div class="mb-4">
                        <label for="product-images" class="form-label">Product Images</label>
                        <div id="product-images" class="border border-secondary rounded p-3">
                            <!-- Image upload inputs are dynamically inserted here -->
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Scripts -->
        <script src="../scripts/ui.js"></script>
        <script>

            let lastAddedProduct = null;
            document.addEventListener('DOMContentLoaded', function () {
                fetchOrders();
            });

            function showAddProductForm() {
                const formSection = document.getElementById('add-product-form');
                formSection.classList.remove('d-none');

                // Scroll into view
                formSection.scrollIntoView({ behavior: 'smooth' });

                // Reset form
                const form = document.getElementById('productForm');
                form.reset();
                [...form.elements].forEach(el => el.disabled = false);

                // Reset buttons
                const cancelBtn = document.querySelector('#add-product-form .btn-light');
                const submitBtn = document.querySelector('#add-product-form .btn-success');

                cancelBtn.textContent = 'Cancel';
                submitBtn.classList.remove('d-none');

                // Replace image upload area with basic input rows
                const dropzone = document.getElementById('product-images');
                dropzone.innerHTML = `
            <div class="mb-2"><small class="text-muted">Upload up to 5 images and optionally set their order.</small></div>
            <div id="image-input-group" class="d-flex flex-column gap-2"></div>
            `;

                const imageInputGroup = document.getElementById('image-input-group');
                for (let i = 1; i <= 5; i++) {
                    const row = document.createElement("div");
                    row.className = "d-flex align-items-center gap-2";

                    const fileInput = document.createElement("input");
                    fileInput.type = "file";
                    fileInput.accept = "image/*";
                    fileInput.name = "images[]";
                    fileInput.className = "form-control";

                    const orderInput = document.createElement("input");
                    orderInput.type = "number";
                    orderInput.min = "1";
                    orderInput.max = "5";
                    orderInput.placeholder = "Order";
                    orderInput.name = "orders[]";
                    orderInput.className = "form-control";
                    orderInput.style.maxWidth = "100px";

                    row.appendChild(fileInput);
                    row.appendChild(orderInput);
                    imageInputGroup.appendChild(row);
                }

                // Refresh visible fields
                const initialCategory = document.getElementById('product-category').value;
                updateVisibleFields(initialCategory);
            }

            const categoryFieldMap = {
                'Smartphones': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'processor', 'screen', 'ram_memory', 'storage', 'os', 'year'
                ],
                'Laptops & PCs': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'processor', 'screen', 'ram_memory', 'graphics_card',
                    'storage', 'keyboard', 'os', 'year'
                ],
                'Smartwatches': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'year'
                ],
                'Gaming': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'storage', 'year'
                ],
                'TVs & Monitors': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'screen', 'year'
                ],
                'Audio': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'year'
                ],
                'Tablets': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'processor', 'screen', 'ram_memory', 'storage', 'os', 'year'
                ],
                'Cameras': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'processor', 'screen', 'storage', 'os', 'year'
                ],
                'Accessories': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'year'
                ],
                'Home Appliances': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'year'
                ],
                'Other': [
                    'name', 'product_condition', 'availability', 'brand', 'model_code', 'color',
                    'weight', 'dimensions', 'year'
                ]
            };





            function updateVisibleFields(category) {
                const allFields = [
                    'name',
                    'product_condition',
                    'availability',
                    'category',
                    'brand',
                    'model_code',
                    'color',
                    'weight',
                    'dimensions',
                    'processor',
                    'screen',
                    'ram_memory',
                    'graphics_card',
                    'storage',
                    'keyboard',
                    'os',
                    'year'
                ];


                allFields.forEach(field => {
                    const group = document.getElementById(`form-group-${field}`);
                    if (group) group.classList.add('d-none');
                });

                const visibleFields = categoryFieldMap[category] || [];
                visibleFields.forEach(field => {
                    const group = document.getElementById(`form-group-${field}`);
                    if (group) group.classList.remove('d-none');
                });
            }



            document.getElementById('product-category').addEventListener('change', function () {
                const selectedCategory = this.value;
                updateVisibleFields(selectedCategory);
            });

            // Inicializa no carregamento
            const initialCategory = document.getElementById('product-category').value;
            updateVisibleFields(initialCategory);


            document.getElementById('productForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const form = e.target;
                const data = {};

                const fields = [
                    'name', 'store_nipc', 'product_condition', 'availability', 'description', 'category',
                    'brand', 'model_code', 'color', 'weight', 'dimensions', 'processor',
                    'screen', 'ram_memory', 'graphics_card', 'storage', 'keyboard', 'os', 'year'
                ];

                fields.forEach(field => {
                    const el = form.elements[field];
                    if (el) {
                        if (el.type === 'checkbox') {
                            data[field] = el.checked;
                        } else if (el.type === 'number') {
                            data[field] = el.value ? parseFloat(el.value) : null;
                        } else {
                            data[field] = el.value || null;
                        }
                    }
                });

                data.availability = '0';

                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                if (loggedInUser && loggedInUser.store) {
                    data.store_nipc = loggedInUser.store;
                } else {
                    showMessage('Error', 'No store information found for the logged-in user.', "danger");
                    return;
                }

                try {
                    // Submit product
                    const res = await fetch('/tt/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!res.ok) {
                        const err = await res.json();
                        showMessage('Error', 'Failed to add product: ' + err.error, "danger");
                        return;
                    }

                    const addedProduct = await res.json();

                    // Save product ID and name globally
                    lastAddedProduct = {
                        id: addedProduct.id,
                        name: addedProduct.name
                    };
                    console.log("Saved product:", lastAddedProduct);

                    // Collect image filenames and orders
                    const rows = document.querySelectorAll('#image-input-group > div');
                    const formData = new FormData();

                    formData.append('product_id', addedProduct.id);

                    const orders = [];

                    rows.forEach((row, idx) => {
                        const fileInput = row.querySelector('input[type="file"]');
                        const orderInput = row.querySelector('input[type="number"]');

                        if (fileInput.files[0]) {
                            const file = fileInput.files[0];
                            formData.append('images', file); // append each file
                            const imageOrder = orderInput.value || (idx + 1);
                            orders.push(parseInt(imageOrder));
                        }
                    });

                    formData.append('orders', JSON.stringify(orders)); // send orders array as string

                    const imgRes = await fetch('/tt/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!imgRes.ok) {
                        const err = await imgRes.json();
                        showMessage("Error", err.error, "danger");
                        return;
                    }

                    showMessage('Product added', 'Product added successfully!', "success");

                    // Hide add product form and show product table + filters etc
                    document.getElementById('add-product-form').classList.add('d-none');

                    // Check if repair tab is active
                    const isRepair = document.getElementById("repairTab").classList.contains("active");

                    // Open order form accordingly
                    openOrderForm(isRepair ? 'repair' : 'sell', lastAddedProduct);

                } catch (err) {
                    console.error(err);
                    showMessage('Error', 'Error submitting product.', "danger");
                }
            });


            function openOrderForm(type, product) {
                // Show form
                document.getElementById('ordersTableContainer').style.display = 'none';
                document.getElementById('orderFormContainer').style.display = 'block';

                // Switch tabs
                document.getElementById('sellTab').classList.toggle('active', type === 'sell');
                document.getElementById('repairTab').classList.toggle('active', type === 'repair');
                document.getElementById('sellFields').style.display = (type === 'sell') ? 'block' : 'none';
                document.getElementById('repairFields').style.display = (type === 'repair') ? 'block' : 'none';

                // Fill fields
                if (product) {
                    if (type === 'repair') {
                        document.getElementById('repair-product-name').value = product.name;
                        document.getElementById('repair-product-id').value = product.id;
                    } else {
                        document.getElementById('sell-product-name').value = product.name;
                        document.getElementById('sell-product-id').value = product.id;
                    }
                }
            }




            /////////////////up, is the add product form////////////////////////////////


            function animateListItems(containerSelector) {
                const container = document.querySelector(containerSelector);
                if (!container) return;

                const items = container.children;

                Array.from(items).forEach((item, index) => {
                    item.classList.add('animate-item');
                    item.style.animationDelay = `${index * 70}ms`;
                });
            }
            let currentOrderType = null; // 'repair' or 'sell'

            function openProductForm(orderType) {
                currentOrderType = orderType;
                document.getElementById('orderFormContainer').style.display = 'none';
                showAddProductForm();
            }

            function hideAddProductForm() {
                document.getElementById('add-product-form').classList.add('d-none');

                // Re-show the order form if it was launched from there
                if (currentOrderType === 'repair' || currentOrderType === 'sell') {
                    document.getElementById('orderFormContainer').style.display = 'block';
                }
            }
            function disableHiddenFields() {
                const sellFields = document.getElementById("sellFields");
                if (sellFields.style.display === "none") {
                    sellFields.querySelectorAll("input").forEach(input => {
                        input.disabled = true;
                    });
                }
            }


            // Handle showing the Add Order form
            function showOrderForm() {
                // Default to repair tab active
                openOrderForm('repair', lastAddedProduct || { id: '', name: '' });
            }


            // Return to Orders Table
            function showOrdersTable() {
                document.getElementById('ordersTableContainer').style.display = 'block';
                document.getElementById('orderFormContainer').style.display = 'none';
                fetchOrders();

            }

            // Switch between Sell and Repair tabs
            function switchOrderType(type) {
                const sellFields = document.getElementById('sellFields');
                const repairFields = document.getElementById('repairFields');
                const sellTab = document.getElementById('sellTab');
                const repairTab = document.getElementById('repairTab');

                if (type === 'sell') {
                    sellFields.style.display = 'block';
                    repairFields.style.display = 'none';
                    sellTab.classList.add('active');
                    repairTab.classList.remove('active');
                } else if (type === 'repair') {
                    sellFields.style.display = 'none';
                    repairFields.style.display = 'block';
                    sellTab.classList.remove('active');
                    repairTab.classList.add('active');
                }
            }

            async function fetchOrders() {
                const repairList = document.getElementById('order-list');
                repairList.innerHTML = '';

                let totalOrdersCount = 0;

                // Fetch Repair Orders
                try {
                    const resRepairs = await fetch('/tttransaction/repairs');
                    const repairs = await resRepairs.json();

                    async function fetchProductName(productId) {
                        if (!productId) return 'N/A';
                        try {
                            const res = await fetch(`/tt/product/${productId}`);
                            if (!res.ok) throw new Error('Product fetch failed');
                            const product = await res.json();
                            return `${product.name} - <i>${product.description}</i>` || 'Unnamed Product';
                        } catch (e) {
                            console.error(`Error fetching product ${productId}:`, e);
                            return 'Unknown Product';
                        }
                    }

                    console.log('Fetched repair orders:', repairs);

                    repairs.forEach(async repair => {
                        const row = document.createElement('tr');

                        // Use client or non_registered_client
                        const clientEmail = repair.client || repair.non_registered_client || 'N/A';

                        // Format transaction_value as float with 2 decimals
                        const price = repair.transaction_value ? parseFloat(repair.transaction_value).toFixed(2) : '0.00';

                        // Repair status with fallback
                        const statusDisplay = repair.repair_status || 'Unknown';

                        let productName = await fetchProductName(repair.product_id);
                        row.innerHTML = `
                        <td>${repair.transaction_id || 'N/A'}</td>
                        <td>${clientEmail}</td>
                        <td>Repair Order</td>
                        <td>${productName}</td>
                        <td>€${price}</td>
                        <td>${statusDisplay}</td>
                        `;

                        repairList.appendChild(row);
                        totalOrdersCount++;
                    });
                } catch (err) {
                    console.error('Error fetching repair orders:', err);
                }

                // Fetch Sales Orders
                try {
                    const resSales = await fetch('/tttransaction/sales');
                    const sales = await resSales.json();

                    console.log('Fetched sales orders:', sales);

                    sales.forEach(sale => {
                        const row = document.createElement('tr');

                        const productNames = sale.sold_products.map(p => p.name).join(', ');
                        const totalPrice = sale.transaction_value || '0.00';

                        row.innerHTML = `
                        <td>${sale.id || 'N/A'}</td>
                        <td>${sale.client || 'N/A'}</td>
                        <td>Sales Order</td>
                        <td>${productNames || 'No products'}</td>
                        <td>€${totalPrice}</td>
                        <td>${sale.sale_status || 'N/A'}</td>
                    `;

                        repairList.appendChild(row);
                        totalOrdersCount++;
                    });
                } catch (err) {
                    console.error('Error fetching sales orders:', err);
                }

                // Fetch Purchase Transactions
                try {
                    const resPurchases = await fetch('/tttransaction/purchases/');
                    const purchases = await resPurchases.json();

                    console.log('Fetched purchase transactions:', purchases);

                    purchases.forEach(purchase => {
                        const row = document.createElement('tr');

                        row.innerHTML = `
                        <td>${purchase.id || 'N/A'}</td>
                        <td>${purchase.client || 'N/A'}</td>
                        <td>Purchase</td>
                        <td>${purchase.item_name || 'Unknown Item'}</td>
                        <td>€${isNaN(Number(purchase.transaction_value)) ? '0.00' : Number(purchase.transaction_value).toFixed(2)}</td>
                        <td>Completed</td>
                    `;

                        repairList.appendChild(row);
                        totalOrdersCount++;
                    });
                } catch (err) {
                    console.error('Error fetching purchase transactions:', err);
                }

                // Show message if no orders found
                if (totalOrdersCount === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="6" class="text-center">No orders found.</td>`;
                    repairList.appendChild(row);
                }
            }


            // Handle form submission for repair orders
            document.getElementById("orderForm").addEventListener("submit", async function (e) {
                e.preventDefault();

                const isRepair = document.getElementById("repairTab").classList.contains("active");
                const isSell = document.getElementById("sellTab").classList.contains("active");

                // Disable inputs in hidden fields
                document.querySelectorAll("#repairFields input, #repairFields textarea").forEach(el => {
                    el.disabled = !isRepair;
                });
                document.querySelectorAll("#sellFields input, #sellFields textarea").forEach(el => {
                    el.disabled = !isSell;
                });

                if (isSell) {
                    const productId = document.getElementById("sell-product-id").value.trim();
                    const clientEmail = document.getElementById("purchase-product-seller-email").value.trim();
                    const price = parseFloat(document.getElementById("purchase-price").value.trim());

                    if (!productId || !clientEmail || isNaN(price)) {
                        showMessage('Warning', "Please fill in all required fields.", "warning");
                        return;
                    }

                    try {
                        const response = await fetch('/tttransaction/purchases/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                non_registered_client: clientEmail,
                                transaction_value: price,
                                purchasing_store: JSON.parse(localStorage.getItem("loggedInUser")).store,
                                item_purchased: parseInt(productId)
                            })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            showMessage('Transaction Recorded', "Product purchase transaction recorded successfully.", "success");
                            document.getElementById("orderForm").reset();
                            document.getElementById("repair-product-name").value = "";
                            document.getElementById("sell-product-name").value = "";
                            document.getElementById("selected-repair-parts").innerHTML = "";
                            showOrdersTable();
                        } else {
                            showMessage('Error', (result.error || response.statusText), "danger");
                        }
                    } catch (err) {
                        console.error("Buy-back submit failed:", err);
                        showMessage('Error', "An unexpected error occurred.", "danger");
                    }
                }

                // Re-enable all fields after submission for future use
                document.querySelectorAll("#repairFields input, #repairFields textarea").forEach(el => {
                    el.disabled = false;
                });
                document.querySelectorAll("#sellFields input, #sellFields textarea").forEach(el => {
                    el.disabled = false;
                });
            });


            // Initial load
            window.onload = function () {
                fetchOrders();
            };

            let selectedRepairParts = [];

            function openRepairPartsSelector() {
                fetch('/tt/repairParts')
                    .then(res => res.json())
                    .then(parts => {
                        const modal = document.createElement('div');
                        modal.className = 'modal fade';
                        modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Repair Parts</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="repair-parts-selector-form">
                                ${parts.map(part => `
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="${part.id}" data-price="${part.price}" id="part-${part.id}">
                                        <label class="form-check-label" for="part-${part.id}">${part.name} (€${parseFloat(part.price).toFixed(2)})</label>
                                    </div>
                                `).join('')}
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="confirm-parts-btn">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
                        document.body.appendChild(modal);

                        const bsModal = new bootstrap.Modal(modal);
                        bsModal.show();

                        modal.querySelector('#confirm-parts-btn').addEventListener('click', () => {
                            selectedRepairParts = [];
                            const selected = modal.querySelectorAll('input[type="checkbox"]:checked');

                            const list = document.getElementById('selected-repair-parts');
                            list.innerHTML = '';

                            selected.forEach(cb => {
                                const id = cb.value;
                                const name = cb.nextElementSibling.innerText;
                                const price = parseFloat(cb.dataset.price);
                                selectedRepairParts.push({ id, name, price });

                                const li = document.createElement('li');
                                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                                li.textContent = name;
                                li.innerHTML += `<span class="badge bg-secondary">€${price.toFixed(2)}</span>`;
                                list.appendChild(li);
                            });

                            bsModal.hide();
                            modal.remove();
                            updateCalculatedPrice();
                        });
                    });
            }

            document.getElementById('profit-percentage').addEventListener('change', updateCalculatedPrice);

            function updateCalculatedPrice() {
                const baseTotal = selectedRepairParts.reduce((sum, part) => sum + part.price, 0);
                const profit = parseFloat(document.getElementById('profit-percentage').value || 0);
                const finalPrice = baseTotal + (baseTotal * profit);

                document.getElementById('repair-price').value = `€${finalPrice.toFixed(2)}`;
            }

            /** PAYPAL **/

            const repairPriceInput = document.getElementById("repair-price");
            const repairProductIdInput = document.getElementById("repair-product-id");
            const repairClientInput = document.getElementById("repair-client");
            const repairProfitInput = document.getElementById("profit-percentage");
            const paypalContainer = document.getElementById("paypal-button-container");

            let paypalRendered = false;

            function canRenderPayPal() {
                return (
                    repairPriceInput.value.trim() !== "" &&
                    repairProductIdInput.value.trim() !== "" &&
                    repairClientInput.value.trim() !== ""
                );
            }

            function renderPayPalOnce() {
                if (!paypalRendered) {
                    paypalRendered = true;
                    renderPayPal();
                }
                setPayPalEnabled(canRenderPayPal());
            }

            function addDisableOverlay() {
                const paypalDiv = document.getElementById("paypal");
                if (paypalDiv) {
                    paypalDiv.style.pointerEvents = "none";
                    paypalDiv.style.opacity = "0.6";
                }
            }

            function enablePayPalClicks() {
                const paypalDiv = document.getElementById("paypal");
                if (paypalDiv) {
                    paypalDiv.style.pointerEvents = "auto";
                    paypalDiv.style.opacity = "1";
                }
            }

            function setPayPalEnabled(enabled) {
                if (enabled) {
                    enablePayPalClicks();
                } else {
                    addDisableOverlay();
                }
            }

            const inputs = [repairPriceInput, repairProductIdInput, repairClientInput, repairProfitInput];

            function onInputChanged() {
                renderPayPalOnce();
            }
            const observer = new MutationObserver(mutations => {
                for (const mutation of mutations) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                        onInputChanged();
                        break;
                    }
                }
            });

            // Observe the inputs for attribute changes (value attribute)
            inputs.forEach(input => {
                observer.observe(input, { attributes: true });
            });

            ["input", "change"].forEach(event =>
                inputs.forEach(el => el.addEventListener(event, renderPayPalOnce))
            );

            /* PayPal */

            /**
             * Renders the PayPal button and handles the PayPal payment flow.
             * 
             * @function renderPayPal
             * @returns {void}
             */
            const renderPayPal = () => paypal.Buttons({
                fundingSource: paypal.FUNDING.PAYPAL,
                style: {
                    layout: 'vertical',
                    borderRadius: 10,
                    label: 'paypal',
                    disableMaxWidth: true,
                    align: 'center',
                },
                createOrder: function (data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: repairPriceInput.value.replace(/€/g, '').trim()
                            }
                        }],
                        application_context: {
                            brand_name: "TechThrift",
                            shipping_preference: "NO_SHIPPING"
                        }
                    })
                },
                onError: function (err) {
                    // Triggered when purchase fails
                    showMessage("Payment Declined", "Your payment was declined or cancelled.", "danger");
                },
                onApprove: async function (data, actions) {
                    const productId = document.getElementById("repair-product-id").value.trim();
                    const price = parseFloat(document.getElementById("repair-price").value.replace(/[€\s]/g, ''));
                    const client = document.getElementById("repair-client").value;
                    const nonRegisteredChecked = document.getElementById("non-registered-checkbox").checked;

                    if (!nonRegisteredChecked) {
                        try {
                            const res = await fetch(`/ttuser?email=${encodeURIComponent(client)}`);
                            if (res.status === 204) {
                                showMessage('Error', "Client is not registered", "danger");
                                return; // stop submission
                            }
                            if (!res.ok) {
                                showMessage('Error', "Error checking client registration", "danger");
                                return;
                            }
                        } catch (error) {
                            console.error("Error fetching client:", error);
                            showMessage('Error', "Error checking client registration", "danger");
                            return;
                        }
                    }

                    // Capture payment
                    return actions.order.capture().then(function (details) {
                        // Store transaction in the database
                        return fetch('/tttransaction/repairs/add', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ...(document.getElementById("non-registered-checkbox").checked
                                    ? { non_registered_client: client }
                                    : { client: client }),
                                transaction_value: price,
                                order_number: details.id,
                                product_id: productId,
                                employee: JSON.parse(localStorage.getItem("loggedInUser")).id,
                                store: JSON.parse(localStorage.getItem("loggedInUser")).store,
                                network: details.payment_source?.card?.brand ? details.payment_source.card.brand.charAt(0).toUpperCase() : 'PayPal'
                            })
                        }).then(response => {
                            if (!response.ok) throw new Error("Failed to store transaction.");
                            // Show success
                            showMessage("Payment Successful",
                                "Your payment was successful!",
                                "success");
                            showOrdersTable();
                            document.getElementById("orderForm").reset();
                            document.getElementById("repair-product-name").value = "";
                            document.getElementById("selected-repair-parts").innerHTML = "";
                            return response.json();
                        }).catch(err => {
                            console.error("Error storing transaction:", err);
                            showMessage("Payment Error",
                                "Your payment was successful but there was an error processing your order.",
                                "alert");
                        });
                    })
                        .catch(err => {
                            showMessage("Payment Unsuccessful",
                                "Sorry, your payment could not be completed.",
                                "danger");
                        });
                }
            }).render('#paypal'); // Render inside the PayPal div

            renderPayPalOnce();

        </script>
        <script src="../scripts/auth.js"></script>
        <!-- Scripts -->
</body>

</html>