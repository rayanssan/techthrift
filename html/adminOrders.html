<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Orders</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap -->
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <script src="https://kit.fontawesome.com/05e3d8d374.js" crossorigin="anonymous"></script>
    <!-- Font Awesome -->
    <!-- Sidebar Script -->
    <script src="../scripts/sidebar.js"></script>
    <!-- Sidebar Script -->
    <!-- Stylesheets -->
    <link rel="stylesheet" href="../styles/stylesheet.css">
    <style>
        .nav-tabs .nav-link {
            border: none;
            position: relative;
            font-weight: bold;
        }

        .nav-tabs .nav-link.active::after {
            content: "";
            position: absolute;
            left: 0;
            bottom: -2px;
            width: 100%;
            height: 3px;
            background-color: rgb(114, 114, 121);
            transition: width 0.3s ease-in-out;
        }
    </style>
    <!-- Stylesheets -->
</head>

<body>
    <!-- Header -->
    <header class="p-3 border-bottom bg-white">
        <div class="d-flex justify-content-between container">
            <div class="row align-items-center gap-3">
                <!-- Left elements -->
                <div class="col-lg-5 col-md-12 col-12 d-flex w-auto align-items-center">
                    <a id="header-brand" href="/adminDashboard" class="ms-1">
                        <img alt="TechThrift's logo" src="../media/images/logo_hor_partners.png">
                    </a>
                </div>
                <!-- Left elements -->
            </div>
            <a href="/authentication" id="username" class="border 
                rounded py-1 px-3 nav-link d-flex h-auto
                align-self-center
                align-items-center btn btn-light">
                <i class="fas fa-user-alt m-1 me-md-2"></i>
                <p class="d-none d-md-block mb-0">···</p>
            </a>
        </div>
    </header>
    <!-- Header -->

    <div class="d-flex">
        <div class="sidebar p-3 bg-light vh-100" style="width: 250px;">
            <h4 class="text-center">Admin Panel</h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminDashboard"><i
                            class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminProducts"><i class="fas fa-box me-2"></i>Products</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminOrders"><i class="fas fa-shopping-cart me-2"></i>Orders</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminCharities"><i class="fas fa-users me-2"></i>Charities</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="adminDonations"><i
                            class="fas fa-hand-holding-heart me-2"></i>Donations</a>
                </li>
            </ul>
        </div>

        <div class="content p-4" style="flex-grow: 1;">
            <div id="ordersTableContainer">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Orders</h2>
                    <button class="btn btn-success" onclick="showOrderForm()">Add Order</button>
                </div>
                <div class="table-responsive" id="order-table">
                    <div class="rounded-3 border overflow-hidden">
                        <table class="table table-borderless table-striped table-hover rounded-3 overflow-hidden">
                            <thead class="table-light">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Type</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="order-list" class="animate-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- Repair Order Form -->
            <div id="orderFormContainer" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Add Order</h2>
                    <button class="btn btn-light me-2" onclick="showOrdersTable()">Cancel</button>
                </div>
                <ul class="nav nav-tabs" id="orderTypeTabs">
                    <li class="nav-item">
                        <a class="nav-link" id="sellTab" onclick="switchOrderType('sell')">Client Sell Order</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" id="repairTab" onclick="switchOrderType('repair')">Product Repair
                            Order</a>
                    </li>
                </ul>

                <form id="orderForm" class="mt-3">
                    <!-- Repair Form Fields -->
                    <div id="repairFields">
                        <div class="mb-3">
                            <label for="repair-product-id" class="form-label">Product ID</label>
                            <input type="text" class="form-control" id="repair-product-id"
                                placeholder="Enter Product ID" required>
                        </div>
                        <div class="mb-3">
                            <label for="repair-description" class="form-label">Issue Description</label>
                            <textarea class="form-control" id="repair-description" placeholder="Enter Issue Description"
                                required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="repair-price" class="form-label">Repair Price</label>
                            <input type="number" class="form-control" id="repair-price" placeholder="Enter Repair Price"
                                required>
                        </div>
                    </div>

                    <!-- You can include sellFields if needed -->
                    <div id="sellFields" style="display: none;">
                        <form id="register-purchase-form">
                            <div class="mb-3">
                                <label for="purchase-product-seller-email" class="form-label">Seller Email</label>
                                <input type="email" class="form-control" id="purchase-product-seller-email"
                                    placeholder="Enter Seller Email" required>
                            </div>
                            <div class="mb-3">
                                <label for="purchase-price" class="form-label">Price</label>
                                <input type="number" class="form-control" id="purchase-price" placeholder="Enter Price"
                                    required>
                            </div>

                        </form>
                    </div>


                    <button type="submit" class="btn btn-primary w-100">Submit Order</button>
                </form>
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script src="../scripts/auth.js"></script>
    <script>
        function animateListItems(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;

            const items = container.children;

            Array.from(items).forEach((item, index) => {
                item.classList.add('animate-item');
                item.style.animationDelay = `${index * 70}ms`;
            });
        }
        // Handle showing the Add Order form
        function showOrderForm() {
            document.getElementById('ordersTableContainer').style.display = 'none';
            document.getElementById('orderFormContainer').style.display = 'block';
            switchOrderType('sell'); // Default to sell order
        }

        // Return to Orders Table
        function showOrdersTable() {
            document.getElementById('ordersTableContainer').style.display = 'block';
            document.getElementById('orderFormContainer').style.display = 'none';
        }

        // Switch between Sell and Repair tabs
        function switchOrderType(type) {
            const sellFields = document.getElementById('sellFields');
            const repairFields = document.getElementById('repairFields');
            const sellTab = document.getElementById('sellTab');
            const repairTab = document.getElementById('repairTab');

            if (type === 'sell') {
                sellFields.style.display = 'block';
                repairFields.style.display = 'none';
                sellTab.classList.add('active');
                repairTab.classList.remove('active');
            } else if (type === 'repair') {
                sellFields.style.display = 'none';
                repairFields.style.display = 'block';
                sellTab.classList.remove('active');
                repairTab.classList.add('active');
            }
        }

        // Fetch and display repair orders in the table
        async function fetchRepairOrders() {
            try {
                const res = await fetch('/tt/repair');
                const repairs = await res.json();
                const repairList = document.getElementById('order-list');
                repairList.innerHTML = '';

                repairs.forEach(repair => {
                    const row = document.createElement('tr');

                    const orderIdCell = document.createElement('td');
                    orderIdCell.textContent = repair.id || 'N/A';
                    row.appendChild(orderIdCell);

                    const typeCell = document.createElement('td');
                    typeCell.textContent = 'Repair Order';
                    row.appendChild(typeCell);

                    const detailsCell = document.createElement('td');
                    detailsCell.textContent = repair.name || 'Unnamed Product';
                    row.appendChild(detailsCell);

                    const statusCell = document.createElement('td');
                    statusCell.textContent = repair.status ? 'Completed' : 'Pending';
                    row.appendChild(statusCell);

                    repairList.appendChild(row);
                });
            } catch (err) {
                console.error('Error fetching repair orders:', err);
            }
        }

        // Handle form submission for repair orders
        document.getElementById("orderForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const isRepair = document.getElementById("repairTab").classList.contains("active");

            if (isRepair) {
                const productId = document.getElementById("repair-product-id").value.trim();
                const description = document.getElementById("repair-description").value.trim();
                const price = document.getElementById("repair-price").value;

                if (!productId || !description || !price) {
                    alert("Please fill in all required fields.");
                    return;
                }

                try {
                    const response = await fetch('/tt/repair/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: productId,
                            description: description,
                            price: parseFloat(price)
                        }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert("Repair order added successfully.");
                        showOrdersTable();
                        fetchRepairOrders();
                    } else {
                        alert("Error: " + (result.error || response.statusText));
                    }
                } catch (err) {
                    console.error("Submit failed:", err);
                    alert("An unexpected error occurred.");
                }
            } else {
                // Handle sell order submission (if needed)
            }
        });


        // Initial load
        window.onload = function () {
            fetchRepairOrders();
        };
    </script>
    <!-- Scripts -->
</body>

</html>